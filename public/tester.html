<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>UnderwriteIQ — MATRIX TEST HARNESS</title>

<style>
/* REAL MATRIX FONT STYLE */
body {
  margin: 0;
  background: #000;
  font-family: "Courier New", monospace;
  color: #00ff41;
}

/* Canvas background (real Matrix rain) */
#matrixCanvas {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: -1;
}

/* Terminal container */
.wrapper {
  padding: 40px;
  position: relative;
  z-index: 10;
}

/* Glow text */
h1, h2, h3 {
  letter-spacing: 1px;
  text-shadow: 0 0 5px #00ff41;
}

/* Upload zone */
#dropzone {
  border: 1px dashed #00ff41;
  padding: 40px;
  text-align: center;
  cursor: pointer;
  margin-bottom: 20px;
  background: rgba(0, 20, 0, 0.4);
}

/* Results */
.file-result {
  padding: 12px;
  margin-bottom: 12px;
  background: rgba(0, 40, 0, 0.4);
  white-space: pre-wrap;
  border-left: 3px solid #00ff41;
}

.fail { border-color: #ff0044; }

/* Progress bar */
#loaderBar {
  height: 5px;
  width: 0%;
  background: #00ff41;
  box-shadow: 0 0 10px #00ff41;
  margin-top: 10px;
}

button {
  background: transparent;
  border: 1px solid #00ff41;
  padding: 10px 20px;
  color: #00ff41;
  cursor: pointer;
  font-family: inherit;
  margin-top: 20px;
}
button:hover {
  background: rgba(0, 50, 0, 0.5);
}
</style>
</head>

<body>

<canvas id="matrixCanvas"></canvas>

<div class="wrapper">
  <h1>UNDERWRITEIQ — MATRIX INTERNAL HARNESS</h1>

  <div id="dropzone">DRAG OR CLICK TO UPLOAD PDF(s)</div>
  <input type="file" id="fileInput" accept="application/pdf" multiple style="display:none">

  <h3>PROGRESS</h3>
  <div id="progress">Waiting…</div>
  <div id="loaderBar"></div>

  <h3>SUCCESS</h3>
  <div id="results"></div>

  <h3>FAILED</h3>
  <div id="fails"></div>

  <button id="exportBtn">EXPORT JSON</button>
</div>

<script>
/* MATRIX RAIN BACKGROUND */
const canvas = document.getElementById("matrixCanvas");
const ctx = canvas.getContext("2d");

canvas.height = window.innerHeight;
canvas.width = window.innerWidth;

const letters = "アァカサタナハマヤラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const matrix = letters.split("");

let fontSize = 14;
let columns = canvas.width / fontSize;
let drops = Array.from({ length: columns }, () => 1);

function drawMatrix() {
  ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#00ff41";
  ctx.font = fontSize + "px Courier";

  drops.forEach((y, i) => {
    const text = matrix[Math.floor(Math.random() * matrix.length)];
    ctx.fillText(text, i * fontSize, y * fontSize);
    if (y * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
    drops[i]++;
  });
}

setInterval(drawMatrix, 33);


/* CORE TESTER LOGIC — CLEANED + MINIMAL */
const fileInput = document.getElementById("fileInput");
const dropzone = document.getElementById("dropzone");
const resultsDiv = document.getElementById("results");
const failsDiv = document.getElementById("fails");
const progress = document.getElementById("progress");
const loader = document.getElementById("loaderBar");
const exportBtn = document.getElementById("exportBtn");

let allResults = [];

dropzone.onclick = () => fileInput.click();
fileInput.onchange = () => handleFiles(fileInput.files);

dropzone.ondragover = e => { e.preventDefault(); dropzone.style.background = "#002400"; };
dropzone.ondragleave = () => dropzone.style.background = "rgba(0,20,0,0.4)";
dropzone.ondrop = e => { e.preventDefault(); dropzone.style.background = "rgba(0,20,0,0.4)"; handleFiles(e.dataTransfer.files); };

async function handleFiles(files) {
  resultsDiv.innerHTML = "";
  failsDiv.innerHTML = "";
  allResults = [];

  let done = 0;
  const total = files.length;

  for (const file of files) {
    await processOne(file);
    done++;
    const pct = Math.floor((done / total) * 100);
    loader.style.width = pct + "%";
    progress.innerText = `Processing ${done}/${total} (${pct}%)`;
  }

  progress.innerText = "✔ COMPLETE";
}

async function processOne(file) {
  const fd = new FormData();
  fd.append("file", file);

  let json;
  try {
    const res = await fetch("/api/lite/parse-report", { method: "POST", body: fd });
    json = await res.json();
  } catch (err) {
    json = { ok: false, error: err.toString() };
  }

  allResults.push({ file: file.name, result: json });

  const div = document.createElement("div");
  div.className = "file-result " + (json.ok ? "" : "fail");
  div.innerHTML = `<strong>${file.name}</strong>\n${JSON.stringify(json, null, 2)}`;

  (json.ok ? resultsDiv : failsDiv).appendChild(div);
}

exportBtn.onclick = () => {
  const blob = new Blob([JSON.stringify(allResults, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "matrix-test-results.json";
  a.click();
};
</script>

</body>
</html>
