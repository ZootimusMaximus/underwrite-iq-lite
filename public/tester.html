<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>UnderwriteIQ — MATRIX INTERNAL HARNESS</title>

<style>
/* -------------------------
   GLOBAL MATRIX STYLING
--------------------------*/
body {
  margin: 0;
  background: #000;
  font-family: "Courier New", monospace;
  color: #00ff41;
  overflow-x: hidden;
}

/* Real Matrix rain canvas */
#matrixCanvas {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: -2;
  opacity: 0.06; /* Subtle, movie-accurate */
  filter: blur(1px);
}

/* Vignette for cinematic depth */
body::after {
  content: "";
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.7) 100%);
  pointer-events: none;
  z-index: -1;
}

/* Wrapper */
.wrapper {
  padding: 40px;
  position: relative;
  z-index: 10;
}

/* UI text glow */
h1, h2, h3, label {
  color: #00ff41;
  text-shadow: 0 0 5px #00ff41aa;
}

/* Title */
h1 {
  margin-top: 0;
  margin-bottom: 30px;
  font-size: 26px;
  letter-spacing: 1px;
  text-align: center;
}

/* Upload zone */
#dropzone {
  border: 1px dashed #00ff41aa;
  padding: 40px;
  text-align: center;
  cursor: pointer;
  margin-bottom: 20px;
  background: rgba(0, 20, 0, 0.3);
  backdrop-filter: blur(2px);
  transition: 0.3s;
}
#dropzone:hover {
  background: rgba(0, 40, 0, 0.5);
  box-shadow: 0 0 10px #00ff41aa;
}

/* Progress */
#progress {
  margin-top: 10px;
  font-size: 14px;
}
#loaderBar {
  height: 6px;
  width: 0%;
  background: #00ff41;
  box-shadow: 0 0 8px #00ff41;
  margin-top: 8px;
  border-radius: 2px;
  transition: width 0.2s linear;
}

/* Results */
.file-result {
  background: rgba(0, 30, 0, 0.35);
  border-left: 3px solid #00ff41;
  padding: 10px;
  margin-bottom: 12px;
  white-space: pre-wrap;
  border-radius: 4px;
}

.fail {
  border-color: #ff0044;
}

/* Export button */
button {
  background: transparent;
  border: 1px solid #00ff41;
  padding: 10px 20px;
  color: #00ff41;
  cursor: pointer;
  margin-top: 20px;
  font-family: inherit;
  text-shadow: 0 0 5px #00ff41aa;
}
button:hover {
  background: rgba(0, 40, 0, 0.5);
}
</style>
</head>

<body>

<!-- REAL MATRIX RAIN -->
<canvas id="matrixCanvas"></canvas>

<div class="wrapper">
  <h1>UNDERWRITEIQ — MATRIX INTERNAL HARNESS</h1>

  <div id="dropzone">DRAG OR CLICK TO UPLOAD PDF(s)</div>
  <input type="file" id="fileInput" accept="application/pdf" multiple style="display:none">

  <h3>PROGRESS</h3>
  <div id="progress">Waiting…</div>
  <div id="loaderBar"></div>

  <h3>SUCCESS</h3>
  <div id="results"></div>

  <h3>FAILED</h3>
  <div id="fails"></div>

  <button id="exportBtn">EXPORT JSON</button>
</div>


<script>
/* -------------------------
   MATRIX DIGITAL RAIN
--------------------------*/
const canvas = document.getElementById("matrixCanvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const letters = "アカサタナハマヤラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const matrix = letters.split("");

const fontSize = 14;
const columns = Math.floor(canvas.width / fontSize);
const drops = Array.from({ length: columns }, () => Math.random() * canvas.height);

/* Cinematic, slower rain */
function drawMatrix() {
  ctx.fillStyle = "rgba(0, 0, 0, 0.12)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#00cc39";         /* darker matrix green */
  ctx.font = fontSize + "px Courier";

  drops.forEach((y, i) => {
    const char = matrix[Math.floor(Math.random() * matrix.length)];
    ctx.fillText(char, i * fontSize, y * fontSize);

    if (y * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
    drops[i] += 0.9; /* slightly slower */
  });
}
setInterval(drawMatrix, 40);


/* -------------------------
   TEST HARNESS LOGIC
--------------------------*/
const fileInput = document.getElementById("fileInput");
const dropzone = document.getElementById("dropzone");
const resultsDiv = document.getElementById("results");
const failsDiv = document.getElementById("fails");
const progress = document.getElementById("progress");
const loaderBar = document.getElementById("loaderBar");
const exportBtn = document.getElementById("exportBtn");

let allResults = [];

dropzone.onclick = () => fileInput.click();
fileInput.onchange = () => handleFiles(fileInput.files);

dropzone.ondragover = e => { e.preventDefault(); dropzone.style.background = "rgba(0,50,0,0.4)"; };
dropzone.ondragleave = () => dropzone.style.background = "rgba(0,20,0,0.3)";
dropzone.ondrop = e => {
  e.preventDefault();
  dropzone.style.background = "rgba(0,20,0,0.3)";
  handleFiles(e.dataTransfer.files);
};

async function handleFiles(files) {
  resultsDiv.innerHTML = "";
  failsDiv.innerHTML = "";
  allResults = [];

  let done = 0;
  const total = files.length;

  for (const file of files) {
    await handleOne(file);
    done++;

    const pct = Math.floor((done / total) * 100);
    loaderBar.style.width = pct + "%";
    progress.innerText = `Processing ${done}/${total} (${pct}%)`;
  }

  progress.innerText = "✔ COMPLETE";
}

async function handleOne(file) {
  const fd = new FormData();
  fd.append("file", file);

  let json;
  try {
    const res = await fetch("/api/lite/parse-report", {
      method: "POST",
      body: fd
    });
    json = await res.json();
  } catch (err) {
    json = { ok: false, error: err.toString() };
  }

  allResults.push({ filename: file.name, result: json });

  const div = document.createElement("div");
  div.className = "file-result " + (json.ok ? "" : "fail");
  div.innerHTML = `<strong>${file.name}</strong>\n${JSON.stringify(json, null, 2)}`;

  (json.ok ? resultsDiv : failsDiv).appendChild(div);
}

exportBtn.onclick = () => {
  const blob = new Blob([JSON.stringify(allResults, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "underwriteiq-matrix-results.json";
  a.click();

  URL.revokeObjectURL(url);
};
</script>

</body>
</html>
