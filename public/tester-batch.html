<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>UnderwriteIQ — Batch Flow Tester</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* ======================= GLOBAL ======================= */
@font-face{
  font-family:"Matrix";
  src:local("Courier New"),monospace;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Matrix,monospace;
  background:#020617;
  color:#e5f9ff;
  overflow-x:hidden;
}

/* Matrix canvas behind everything */
#matrix{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  z-index:-1;
}

/* CRT scanlines */
body::after{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:repeating-linear-gradient(
    to bottom,
    rgba(0,0,0,0.18) 0px,
    rgba(0,0,0,0.18) 2px,
    rgba(0,0,0,0.22) 3px
  );
  z-index:9999;
  mix-blend-mode:multiply;
  opacity:0.35;
}

/* ======================= UI SHELL ======================= */
#ui{
  position:relative;
  z-index:10;
  padding:24px;
  max-width:1200px;
  margin:0 auto;
}
h1{
  margin:0 0 4px;
  letter-spacing:2px;
  color:#7dfc8a;
  font-size:24px;
}
h2{
  margin:10px 0 0;
  font-size:13px;
  font-weight:400;
  opacity:0.8;
}

/* Dropzone */
#dropzone{
  border:1px dashed rgba(56,189,248,.6);
  padding:18px;
  text-align:center;
  cursor:pointer;
  border-radius:6px;
  background:rgba(15,23,42,.9);
  margin:18px 0 18px;
  font-size:13px;
}
#dropzone:hover{
  background:rgba(15,23,42,1);
}

/* Panels */
.panel{
  margin-bottom:18px;
  background:rgba(15,23,42,.9);
  padding:14px;
  border-radius:6px;
  border:1px solid rgba(56,189,248,.3);
}
.panel h3{
  margin:0 0 10px;
  font-size:14px;
}

/* Progress */
#progress{
  background:rgba(0,0,0,0.6);
  padding:8px;
  border-radius:4px;
  font-size:12px;
  max-height:160px;
  overflow-y:auto;
  white-space:pre-wrap;
}

/* File result wrapper */
.file-result{
  border-radius:10px;
  padding:12px;
  margin-bottom:12px;
  background:linear-gradient(135deg,rgba(15,23,42,1),rgba(15,23,42,.9));
  border:1px solid rgba(56,189,248,.3);
}
.meta-line{
  font-size:11px;
  opacity:0.8;
  margin-bottom:6px;
}
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:10px;
  letter-spacing:0.04em;
  text-transform:uppercase;
  margin-bottom:6px;
}
.badge-ok{
  background:rgba(22,163,74,.2);
  color:#bbf7d0;
  border:1px solid rgba(34,197,94,.5);
}
.badge-error{
  background:rgba(239,68,68,.2);
  color:#fecaca;
  border:1px solid rgba(248,113,113,.6);
}
.badge-fallback{
  background:rgba(234,179,8,.18);
  color:#fef9c3;
  border:1px solid rgba(250,204,21,.5);
}

/* Raw JSON panel for failures */
.raw-json{
  background:#020617;
  border-radius:6px;
  padding:8px;
  font-size:11px;
  max-height:220px;
  overflow:auto;
  white-space:pre-wrap;
}

/* ======================= FLOW CARDS (Approved / Needs Repair) ======================= */
.flow-card{
  display:flex;
  flex-direction:column;
  gap:10px;
  border-radius:10px;
  padding:14px;
  background:radial-gradient(circle at top left,rgba(56,189,248,.16),transparent 55%),
             radial-gradient(circle at bottom right,rgba(34,197,94,.16),transparent 55%),
             rgba(15,23,42,.96);
  border:1px solid rgba(148,163,184,.5);
  box-shadow:0 14px 40px rgba(15,23,42,.9);
}

/* header row */
.flow-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  border-bottom:1px solid rgba(148,163,184,.5);
  padding-bottom:6px;
}
.flow-title{
  font-size:14px;
  font-weight:700;
}
.flow-sub{
  font-size:11px;
  opacity:0.8;
}

/* stat rows */
.flow-main{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.block{
  flex:1 1 180px;
  border-radius:8px;
  padding:10px;
  background:rgba(15,23,42,.96);
  border:1px solid rgba(51,65,85,.9);
}
.block h4{
  margin:0 0 4px;
  font-size:11px;
  letter-spacing:0.04em;
  text-transform:uppercase;
  color:rgba(148,163,184,1);
}
.block-value{
  font-size:18px;
  font-weight:800;
}
.block-meta{
  font-size:11px;
  opacity:0.8;
}

/* chips */
.chip-row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:6px;
}
.chip{
  font-size:10px;
  padding:2px 7px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.7);
  background:rgba(15,23,42,.9);
}

/* bullet list */
.flow-list{
  margin:0;
  padding-left:18px;
  font-size:11px;
  color:rgba(226,232,240,.9);
}
.flow-list li{
  margin-bottom:4px;
}

/* CTA */
.flow-cta{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-top:4px;
}
.flow-cta-text{
  font-size:11px;
  opacity:0.86;
}
.flow-cta-btn{
  background:linear-gradient(135deg,#5b7cfa,#38bdf8);
  border-radius:999px;
  padding:7px 14px;
  font-size:11px;
  font-weight:700;
  border:none;
  color:#fff;
  cursor:pointer;
  box-shadow:0 8px 20px rgba(56,189,248,.35);
}
.flow-cta-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 12px 26px rgba(56,189,248,.55);
}

/* approved / denied accents */
.flow-card.approved .flow-title{
  color:#bbf7d0;
}
.flow-card.needs-repair .flow-title{
  color:#fee2e2;
}
.flow-card.approved .block-value{
  color:#a7f3d0;
}
.flow-card.needs-repair .block-value{
  color:#fca5a5;
}
.flow-card.needs-repair{
  background:radial-gradient(circle at top left,rgba(248,113,113,.2),transparent 55%),
             radial-gradient(circle at bottom right,rgba(250,204,21,.18),transparent 55%),
             rgba(15,23,42,.96);
}

/* glow pulse for totals */
.glow{
  box-shadow:0 0 0 rgba(56,189,248,0);
  transition:box-shadow 0.5s ease-out;
}
.glow-pulse{
  box-shadow:0 0 26px rgba(56,189,248,0.9);
}
</style>
</head>
<body>

<canvas id="matrix"></canvas>

<div id="ui">
  <h1>UNDERWRITEIQ — BATCH FLOW TESTER</h1>
  <h2>Drag 10+ real PDFs here → see EXACT Approved vs Needs Repair flows per file (using /api/lite/parse-report).</h2>

  <div id="dropzone">CLICK OR DRAG CREDIT REPORT PDF(s)</div>
  <input type="file" id="fileInput" accept="application/pdf" multiple style="display:none" />

  <div class="panel">
    <h3>Progress Log</h3>
    <pre id="progress">Waiting…</pre>
  </div>

  <div class="panel">
    <h3>Rendered Flows (1 result per PDF)</h3>
    <div id="results"></div>
  </div>

  <div class="panel">
    <h3>Failures / Fallbacks (raw JSON)</h3>
    <div id="fails"></div>
  </div>
</div>

<script>
/* ======================= MATRIX RAIN ======================= */
const canvas = document.getElementById("matrix");
const ctx = canvas.getContext("2d");

function resizeMatrix(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeMatrix();
window.addEventListener("resize", resizeMatrix);

const chars = "アカサタナハマヤラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const charset = chars.split("");
const fontSize = 16;
let columns = Math.floor(window.innerWidth / fontSize);
let drops = Array.from({length:columns},()=>1);

function drawMatrix(){
  ctx.fillStyle = "rgba(0,0,0,0.07)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = "rgba(0,255,65,0.55)";
  ctx.font = fontSize + "px Matrix";

  drops.forEach((y,i)=>{
    const text = charset[Math.floor(Math.random()*charset.length)];
    ctx.fillText(text, i*fontSize, y*fontSize);
    if(y*fontSize > canvas.height && Math.random()>0.975) drops[i]=0;
    drops[i]++;
  });
}
setInterval(drawMatrix,50);

/* ======================= BATCH TESTER LOGIC ======================= */
const dropzone   = document.getElementById("dropzone");
const fileInput  = document.getElementById("fileInput");
const progressEl = document.getElementById("progress");
const resultsEl  = document.getElementById("results");
const failsEl    = document.getElementById("fails");

dropzone.onclick = ()=>fileInput.click();
fileInput.onchange = ()=>handleFiles(fileInput.files);

dropzone.addEventListener("dragover",e=>{
  e.preventDefault();
});
dropzone.addEventListener("drop",e=>{
  e.preventDefault();
  handleFiles(e.dataTransfer.files);
});

function log(msg){
  progressEl.textContent += "\\n" + msg;
  progressEl.scrollTop = progressEl.scrollHeight;
}

function formatMoney(n){
  n = Number(n || 0);
  if(!Number.isFinite(n)) n = 0;
  return "$" + Math.round(n).toLocaleString();
}

function safeNum(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

/* ======================= FLOW RENDERERS ======================= */
function renderApprovedCard(file, json){
  const uw = json.underwrite || {};
  const metrics = uw.metrics || {};
  const inquiries = metrics.inquiries || {};

  const personal = safeNum(uw.personal && uw.personal.total_personal_funding);
  const business = safeNum(uw.business && uw.business.business_funding);
  const total    = safeNum(uw.totals && uw.totals.total_combined_funding);

  const score = metrics.score ?? "--";
  const util  = metrics.utilization_pct;
  const utilText = (util!=null && Number.isFinite(Number(util))) ? `${util}%` : "--%";

  const exInq = safeNum(inquiries.ex);
  const tuInq = safeNum(inquiries.tu);
  const eqInq = safeNum(inquiries.eq);
  const totalInq = exInq + tuInq + eqInq;

  const neg   = safeNum(metrics.negative_accounts);
  const late  = safeNum(metrics.late_payment_events);

  const primary = (uw.primary_bureau || "primary").toUpperCase();

  const card = document.createElement("div");
  card.className = "file-result";

  const meta = document.createElement("div");
  meta.className = "meta-line";
  meta.textContent = `FILE: ${file.name} — ${(file.size/1024).toFixed(1)} KB`;
  card.appendChild(meta);

  const badge = document.createElement("span");
  badge.className = "badge badge-ok";
  badge.textContent = "APPROVED FLOW";
  card.appendChild(badge);

  const flow = document.createElement("div");
  flow.className = "flow-card approved";

  flow.innerHTML = `
    <div class="flow-header">
      <div>
        <div class="flow-title">Fundable — ${primary} is your strongest bureau.</div>
        <div class="flow-sub">
          UnderwriteIQ™ recommends moving forward to a Funding Review call.
        </div>
      </div>
      <div class="chip-row">
        <div class="chip">Score: ${score}</div>
        <div class="chip">Util: ${utilText}</div>
        <div class="chip">Inquiries: EX ${exInq} • TU ${tuInq} • EQ ${eqInq}</div>
      </div>
    </div>

    <div class="flow-main">
      <div class="block">
        <h4>Total Funding Approved</h4>
        <div class="block-value glow" data-role="total">${formatMoney(total || personal + business)}</div>
        <div class="block-meta">Combined personal + business approvals.</div>
      </div>

      <div class="block">
        <h4>Personal Funding</h4>
        <div class="block-value" data-role="personal">${formatMoney(personal)}</div>
        <div class="block-meta">Cards / lines based on strongest bureau.</div>
      </div>

      <div class="block">
        <h4>Business Funding</h4>
        <div class="block-value" data-role="business">${formatMoney(business)}</div>
        <div class="block-meta">Built on personal profile and business age.</div>
      </div>
    </div>

    <div class="flow-main">
      <div class="block">
        <h4>Profile Snapshot</h4>
        <ul class="flow-list">
          <li>${neg} negative tradeline${neg===1?"":"s"} reporting.</li>
          <li>${late} recent late payment${late===1?"":"s"}.</li>
          <li>${totalInq} recent inquiries across all bureaus.</li>
        </ul>
      </div>

      <div class="block">
        <h4>Optimization Moves</h4>
        <ul class="flow-list">
          <li>Keep each card between 3–10% utilization before and during funding.</li>
          <li>Avoid new inquiries until after your funding sequence is complete.</li>
          <li>Clean old addresses/employers so underwriters see one clear profile.</li>
        </ul>
      </div>
    </div>

    <div class="flow-cta">
      <div class="flow-cta-text">
        Next step: review this plan with a closer and stack your approvals safely.
      </div>
      <button class="flow-cta-btn" type="button">
        View Production “Approved” Page
      </button>
    </div>
  `;

  // simple glow pulse on total
  const totalNode = flow.querySelector('[data-role="total"]');
  if(totalNode){
    setTimeout(()=>{
      totalNode.classList.add("glow-pulse");
      setTimeout(()=>totalNode.classList.remove("glow-pulse"),550);
    },250);
  }

  const btn = flow.querySelector(".flow-cta-btn");
  if(btn){
    btn.addEventListener("click",()=>{
      window.open("https://fundhub.ai/funding-form-748297","_blank");
    });
  }

  card.appendChild(flow);
  resultsEl.appendChild(card);
}

function renderNeedsRepairCard(file, json){
  const uw = json.underwrite || {};
  const metrics = uw.metrics || {};
  const inquiries = metrics.inquiries || {};

  const score = metrics.score ?? "--";
  const util  = metrics.utilization_pct;
  const utilText = (util!=null && Number.isFinite(Number(util))) ? `${util}%` : "--%";

  const exInq = safeNum(inquiries.ex);
  const tuInq = safeNum(inquiries.tu);
  const eqInq = safeNum(inquiries.eq);
  const totalInq = exInq + tuInq + eqInq;

  const neg   = safeNum(metrics.negative_accounts);
  const late  = safeNum(metrics.late_payment_events);

  const personalPotential = safeNum(uw.personal && uw.personal.total_personal_funding) || 200000;
  const businessPotential = safeNum(uw.business && uw.business.business_funding) || 200000;
  const totalPotential    = personalPotential + businessPotential;

  const card = document.createElement("div");
  card.className = "file-result";

  const meta = document.createElement("div");
  meta.className = "meta-line";
  meta.textContent = `FILE: ${file.name} — ${(file.size/1024).toFixed(1)} KB`;
  card.appendChild(meta);

  const badge = document.createElement("span");
  badge.className = "badge badge-error";
  badge.textContent = "NEEDS REPAIR FLOW";
  card.appendChild(badge);

  const flow = document.createElement("div");
  flow.className = "flow-card needs-repair";

  flow.innerHTML = `
    <div class="flow-header">
      <div>
        <div class="flow-title">You’re Close — Credit File Needs Cleanup First.</div>
        <div class="flow-sub">
          UnderwriteIQ™ found blocks that would kill approvals today. Fix these first, then re-run funding.
        </div>
      </div>
      <div class="chip-row">
        <div class="chip">Score: ${score}</div>
        <div class="chip">Util: ${utilText}</div>
        <div class="chip">Negatives: ${neg}</div>
        <div class="chip">Inquiries: ${totalInq}</div>
      </div>
    </div>

    <div class="flow-main">
      <div class="block">
        <h4>Funding Potential After Repair</h4>
        <div class="block-value glow" data-role="total">${formatMoney(totalPotential)}</div>
        <div class="block-meta">Estimated combined personal + business once repaired.</div>
      </div>

      <div class="block">
        <h4>Personal Potential</h4>
        <div class="block-value" data-role="personal">${formatMoney(personalPotential)}</div>
        <div class="block-meta">Cards / lines unlocked after negatives + utilization are fixed.</div>
      </div>

      <div class="block">
        <h4>Business Potential</h4>
        <div class="block-value" data-role="business">${formatMoney(businessPotential)}</div>
        <div class="block-meta">Business funding built on a clean personal profile.</div>
      </div>
    </div>

    <div class="flow-main">
      <div class="block">
        <h4>What’s Holding You Back</h4>
        <ul class="flow-list">
          <li>${neg} negative tradeline${neg===1?"":"s"} reporting across bureaus.</li>
          <li>${late} late payment${late===1?"":"s"} hurting your risk profile.</li>
          <li>${totalInq} recent inquiry${totalInq===1?"":"ies"} triggering “too many pulls” flags.</li>
        </ul>
      </div>

      <div class="block">
        <h4>Quick Fixes (Fastest ROI)</h4>
        <ul class="flow-list">
          <li>Dispute / remove collections and late payments that don’t belong.</li>
          <li>Pay cards down toward 10% utilization (or redistribute balances).</li>
          <li>Stop new inquiries until your Repair Roadmap is complete.</li>
          <li>Clean extra addresses/employers so bureaus show one clean profile.</li>
        </ul>
      </div>
    </div>

    <div class="flow-cta">
      <div class="flow-cta-text">
        Next step: start repair so we can unlock this funding potential safely.
      </div>
      <button class="flow-cta-btn" type="button">
        View Production “Fix My Credit” Page
      </button>
    </div>
  `;

  const totalNode = flow.querySelector('[data-role="total"]');
  if(totalNode){
    setTimeout(()=>{
      totalNode.classList.add("glow-pulse");
      setTimeout(()=>totalNode.classList.remove("glow-pulse"),550);
    },250);
  }

  const btn = flow.querySelector(".flow-cta-btn");
  if(btn){
    btn.addEventListener("click",()=>{
      window.open("https://fundhub.ai/repair-survey-842022","_blank");
    });
  }

  card.appendChild(flow);
  resultsEl.appendChild(card);
}

function renderFallbackCard(file, json){
  const card = document.createElement("div");
  card.className = "file-result";

  const meta = document.createElement("div");
  meta.className = "meta-line";
  meta.textContent = `FILE: ${file.name} — ${(file.size/1024).toFixed(1)} KB`;
  card.appendChild(meta);

  const badge = document.createElement("span");
  badge.className = json && json.ok ? "badge badge-fallback" : "badge badge-error";
  badge.textContent = json && json.ok ? "FALLBACK RESULT" : "ERROR RESULT";
  card.appendChild(badge);

  const pre = document.createElement("pre");
  pre.className = "raw-json";
  pre.textContent = JSON.stringify(json, null, 2);
  card.appendChild(pre);

  failsEl.appendChild(card);
}

/* ======================= FILE HANDLING ======================= */
async function handleFiles(fileList){
  const files = Array.from(fileList || []);
  if(!files.length) return;

  resultsEl.innerHTML = "";
  failsEl.innerHTML = "";
  progressEl.textContent = "Starting batch…";

  let done = 0;
  const total = files.length;

  for(const file of files){
    await processFile(file);
    done++;
    log(`Finished ${done}/${total}`);
  }

  log("DONE — all files processed.");
}

async function processFile(file){
  log(`Processing: ${file.name}`);

  const formData = new FormData();
  formData.append("file", file);

  let json;
  try{
    const res = await fetch("/api/lite/parse-report", {
      method:"POST",
      body:formData
    });

    const text = await res.text();
    try{
      json = JSON.parse(text);
    }catch(e){
      json = { ok:false, parseError:true, raw:text.slice(0,400) };
    }
  }catch(err){
    json = { ok:false, networkError:true, message:String(err) };
  }

  // Decide which flow to render
  if(!json){
    renderFallbackCard(file, { ok:false, message:"Empty response" });
    return;
  }

  // If we got a clean success + real underwrite
  if(json.ok && json.underwrite && typeof json.underwrite === "object"){
    if(json.underwrite.fundable){
      renderApprovedCard(file, json);
    }else{
      renderNeedsRepairCard(file, json);
    }
    return;
  }

  // any fallback / error / weird shape → raw JSON in Failures panel
  renderFallbackCard(file, json);
}
</script>
</body>
</html>
